<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrocZen - ·∫êEN - Bons locaux s√©curis√©s</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Palette TrocZen Flutter Exacte */
            --bg-scaffold: #121212;
            --bg-card: #1E1E1E;
            --bg-input: #2A2A2A;
            --primary: #FFB347;
            --primary-dark: #FF8C42;
            --secondary: #0A7EA4;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #F44336;
            --text-main: #FFFFFF;
            --text-secondary: #B0BEC5;
            --text-muted: #666666;
            --radius: 16px;
            --radius-sm: 8px;
            --padding: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-scaffold);
            color: var(--text-main);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        /* --- HEADER HERO --- */
        .hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 60px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .logo-icon {
            font-size: 80px;
            margin-bottom: 15px;
            display: inline-block;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .hero h1 {
            font-size: 3rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(255,255,255,0.2);
        }

        .hero .subtitle {
            font-size: 1.3rem;
            color: rgba(0,0,0,0.8);
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .hero-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* --- BUTTONS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            gap: 10px;
        }

        .btn-dark {
            background-color: var(--bg-scaffold);
            color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-dark:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid rgba(0,0,0,0.3);
            color: #000;
        }

        .btn-outline:hover {
            background-color: rgba(0,0,0,0.1);
        }

        /* --- LAYOUT --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* --- STATS SECTION --- */
        .stats-section {
            margin-top: -30px;
            position: relative;
            z-index: 2;
            margin-bottom: 40px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px 16px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
        }

        /* --- SECTION TITLES --- */
        .section {
            margin-bottom: 40px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-icon {
            font-size: 1.8rem;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--text-main);
        }

        /* --- CARDS --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* --- MERCHANTS GRID --- */
        .merchants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .merchant-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .merchant-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(255, 179, 71, 0.15);
        }

        .merchant-header {
            background: linear-gradient(135deg, var(--secondary) 0%, #0d5a7d 100%);
            padding: 24px;
            text-align: center;
            position: relative;
        }

        .merchant-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            object-fit: cover;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .merchant-avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 3px solid white;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 2rem;
        }

        .merchant-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .merchant-bons-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--primary);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .merchant-body {
            padding: 20px;
        }

        .merchant-about {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .merchant-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .merchant-tag {
            background: rgba(255, 179, 71, 0.15);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 179, 71, 0.3);
        }

        /* --- MARKETS LIST --- */
        .markets-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .market-chip {
            display: inline-flex;
            align-items: center;
            background: rgba(10, 126, 164, 0.2);
            border: 1px solid var(--secondary);
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        .market-chip:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .market-chip.hackathon {
            border-color: var(--primary);
            background: rgba(255, 179, 71, 0.2);
            color: var(--primary);
        }

        .market-chip.hackathon:hover {
            background: var(--primary);
            color: #000;
        }

        /* --- INFO BOX --- */
        .info-box {
            background: rgba(10, 126, 164, 0.1);
            border-left: 4px solid var(--secondary);
            padding: 16px 20px;
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-bottom: 20px;
        }

        .info-box.primary {
            background: rgba(255, 179, 71, 0.1);
            border-left-color: var(--primary);
        }

        .info-box-title {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .info-box-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* --- FEATURES SECTION --- */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
        }

        .feature-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .feature-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* --- FORM --- */
        .form-group { margin-bottom: 16px; }
        
        input, select, textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid #444;
            color: white;
            padding: 16px;
            border-radius: 12px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
            transition: 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        input::placeholder, textarea::placeholder {
            color: var(--text-muted);
        }

        /* --- QR OVERLAY --- */
        .qr-overlay {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 20px;
            display: none;
            text-align: center;
        }

        .qr-overlay.visible {
            display: block;
        }

        .qr-overlay p {
            color: #333;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* --- FOOTER --- */
        .footer {
            background: var(--bg-card);
            padding: 40px 20px;
            text-align: center;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .footer-link {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-link:hover {
            color: var(--primary);
        }

        .footer-text {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* --- LOADING --- */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-input);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 600px) {
            .hero h1 {
                font-size: 2rem;
            }
            
            .hero .subtitle {
                font-size: 1rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .merchants-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- HERO HEADER -->
    <div class="hero">
        <div class="hero-content">
            <div class="logo-icon">üåª</div>
            <h1>·∫êEN ‚Äî Bons locaux s√©curis√©s</h1>
            <p class="subtitle">Une application d√©centralis√©e pour soutenir les producteurs et commer√ßants locaux</p>
            
            <div class="hero-buttons">
                <a href="#" id="download-apk-btn" class="btn btn-dark">
                    <span>‚¨áÔ∏è</span> T√©l√©charger l'app
                </a>
                <button onclick="toggleQR()" class="btn btn-outline">
                    üì± QR Code
                </button>
            </div>

            <div id="qrOverlay" class="qr-overlay">
                <img src="/api/apk/qr" alt="QR Code" width="180" height="180">
                <p>Scannez pour installer TrocZen</p>
            </div>
        </div>
    </div>

    <div class="container">
        
        <!-- STATS SECTION -->
        <div class="stats-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üè™</div>
                    <div class="stat-value" id="stat-markets">-</div>
                    <div class="stat-label">March√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="stat-profiles">-</div>
                    <div class="stat-label">Commer√ßants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üé´</div>
                    <div class="stat-value" id="stat-bons">-</div>
                    <div class="stat-label">Bons Actifs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì±</div>
                    <div class="stat-value" id="apk-version">v...</div>
                    <div class="stat-label">Version</div>
                </div>
            </div>
        </div>

        <!-- MARCH√âS ACTIFS -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üåê</span>
                <h2 class="section-title">March√©s actifs</h2>
            </div>
            
            <div class="info-box">
                <div class="info-box-title">üì° Donn√©es temps r√©el</div>
                <div class="info-box-text">Source: Relai Nostr Strfry ‚Äî kind 0 (profils) + kind 30303 (bons ·∫êEN)</div>
            </div>
            
            <div class="markets-list" id="markets-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement des march√©s...
                </div>
            </div>
        </div>

        <!-- DERNIERS MARCHANDS -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üè™</span>
                <h2 class="section-title">Derniers Marchands</h2>
            </div>
            
            <div class="merchants-grid" id="merchants-list">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement depuis Nostr...
                </div>
            </div>
        </div>

        <!-- COMMENT √áA MARCHE -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üí°</span>
                <h2 class="section-title">Comment √ßa marche</h2>
            </div>
            
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">üîê</div>
                    <div class="feature-title">Cryptographie</div>
                    <div class="feature-text">Chaque bon est un objet cryptographique unique (P1/P2/P3) sign√© par son √©metteur.</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üì±</div>
                    <div class="feature-title">Double Scan</div>
                    <div class="feature-text">Un double scan atomique garantit que le bon ne peut pas √™tre dupliqu√©.</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üì°</div>
                    <div class="feature-title">R√©seau Nostr</div>
                    <div class="feature-text">Le r√©seau local (P3) assure validation et tra√ßabilit√© sans serveur central.</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úàÔ∏è</div>
                    <div class="feature-title">Offline First</div>
                    <div class="feature-text">Fonctionne m√™me sans r√©seau mobile. Les transactions se synchronisent automatiquement.</div>
                </div>
            </div>
        </div>

        <!-- POUR LES COMMER√áANTS -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üìä</span>
                <h2 class="section-title">Pour les commer√ßants</h2>
            </div>
            
            <div class="card">
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px;">
                        <span style="color: var(--success);">‚úì</span>
                        <span>Recevez les bons des clients instantan√©ment</span>
                    </li>
                    <li style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px;">
                        <span style="color: var(--success);">‚úì</span>
                        <span>Validez les bons avec votre smartphone gr√¢ce au double scan</span>
                    </li>
                    <li style="padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; gap: 12px;">
                        <span style="color: var(--success);">‚úì</span>
                        <span>Participez au r√©seau local pour propager les bons</span>
                    </li>
                    <li style="padding: 12px 0; display: flex; align-items: center; gap: 12px;">
                        <span style="color: var(--success);">‚úì</span>
                        <span>Conservez un historique simple pour vos d√©clarations</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- FEEDBACK FORM -->
        <div class="section">
            <div class="section-header">
                <span class="section-icon">üí¨</span>
                <h2 class="section-title">Feedback & Support</h2>
            </div>
            
            <div class="card">
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Aidez-nous √† am√©liorer TrocZen. Vos retours cr√©ent directement des t√¢ches pour les d√©veloppeurs.
                </p>

                <form id="feedbackForm">
                    <div class="form-group">
                        <select id="fbType">
                            <option value="bug">üêõ Signaler un bug</option>
                            <option value="feature">‚ú® Sugg√©rer une id√©e</option>
                            <option value="question">‚ùì Question</option>
                            <option value="feedback">üëç Avis g√©n√©ral</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <input type="text" id="fbTitle" placeholder="Titre (ex: Probl√®me d'affichage...)" required>
                    </div>

                    <div class="form-group">
                        <textarea id="fbDesc" rows="4" placeholder="Description d√©taill√©e..." required></textarea>
                    </div>

                    <div class="form-group">
                        <input type="email" id="fbEmail" placeholder="Votre email (optionnel)">
                    </div>

                    <button type="submit" class="btn btn-dark" style="width: 100%; background: var(--primary); color: #000;" id="fbSubmitBtn">
                        Envoyer le feedback
                    </button>
                    <div id="fbStatus" style="margin-top: 15px; text-align: center; font-weight: bold;"></div>
                </form>
            </div>
        </div>

    </div>

    <!-- FOOTER -->
    <div class="footer">
        <div class="footer-links">
            <a href="https://github.com/papiche/troczen" class="footer-link" target="_blank">GitHub</a>
            <a href="https://opencollective.com/monnaie-libre" class="footer-link" target="_blank">Soutenir le projet</a>
            <a href="/api/apk/latest" class="footer-link">T√©l√©charger APK</a>
        </div>
        <p class="footer-text">
            üåª TrocZen v1.0 ‚Äî Syst√®me de bons locaux d√©centralis√©<br>
            <small>Python Flask ‚Ä¢ Nostr Relay ‚Ä¢ IPFS ‚Ä¢ Flutter</small>
        </p>
    </div>

    <script>
        // ============================================
        // LOGGING UTILITIES
        // ============================================
        const LOG_PREFIX = 'üåª TrocZen';
        
        function logInfo(component, message, data = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const logMsg = `[${timestamp}] ${LOG_PREFIX} | ${component} | ${message}`;
            console.log(`%c${logMsg}`, 'color: #FFB347; font-weight: bold;', data || '');
        }
        
        function logSuccess(component, message, data = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const logMsg = `[${timestamp}] ${LOG_PREFIX} | ${component} | ‚úÖ ${message}`;
            console.log(`%c${logMsg}`, 'color: #4CAF50; font-weight: bold;', data || '');
        }
        
        function logError(component, message, error = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const logMsg = `[${timestamp}] ${LOG_PREFIX} | ${component} | ‚ùå ${message}`;
            console.error(logMsg, error || '');
        }
        
        function logWarn(component, message, data = null) {
            const timestamp = new Date().toLocaleTimeString('fr-FR');
            const logMsg = `[${timestamp}] ${LOG_PREFIX} | ${component} | ‚ö†Ô∏è ${message}`;
            console.warn(logMsg, data || '');
        }

        // ============================================
        // INIT
        // ============================================
        logInfo('index.html', 'Page charg√©e, initialisation...');
        
        function toggleQR() {
            logInfo('UI', 'Toggle QR Code overlay');
            document.getElementById('qrOverlay').classList.toggle('visible');
        }

        // ============================================
        // CHARGEMENT DES DONN√âES
        // ============================================
        async function loadData() {
            logInfo('loadData', 'D√©but du chargement des donn√©es');
            
            try {
                // 1. Stats G√©n√©rales
                logInfo('loadData', 'R√©cup√©ration des stats g√©n√©rales...');
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();
                logSuccess('loadData', `Stats re√ßues: ${stats.market_count} march√©s, ${stats.profile_count} profils`, stats);
                
                document.getElementById('stat-markets').textContent = stats.market_count || 0;
                document.getElementById('stat-profiles').textContent = stats.profile_count || 0;

                // 2. Gestion des March√©s
                logInfo('loadData', 'Affichage des march√©s...');
                const marketsDiv = document.getElementById('markets-list');
                
                let marketsHtml = `<a href="/market/HACKATHON" class="market-chip hackathon">üèÜ HACKATHON</a>`;

                if (stats.markets && stats.markets.length > 0) {
                    const otherMarkets = stats.markets.filter(m => m !== 'HACKATHON');
                    logInfo('loadData', `${otherMarkets.length} autres march√©s d√©tect√©s`, otherMarkets);
                    marketsHtml += otherMarkets
                        .map(m => `<a href="/market/${m}" class="market-chip">üè™ ${m}</a>`)
                        .join('');
                }
                
                marketsDiv.innerHTML = marketsHtml;
                logSuccess('loadData', 'March√©s affich√©s');

                // 3. Gestion APK
                logInfo('loadData', 'R√©cup√©ration infos APK...');
                const apkResponse = await fetch('/api/apk/latest');
                const apk = await apkResponse.json();
                
                if (!apk.error) {
                    logSuccess('loadData', `APK version ${apk.version} disponible (${(apk.size / 1024 / 1024).toFixed(1)} MB)`, apk);
                    document.getElementById('apk-version').textContent = 'v' + apk.version;
                    const downloadBtn = document.getElementById('download-apk-btn');
                    if (apk.download_url) {
                        downloadBtn.href = apk.download_url;
                    }
                } else {
                    logWarn('loadData', 'Aucun APK disponible');
                }
                
                // 4. Charger les donn√©es Nostr
                logInfo('loadData', 'Chargement des donn√©es Nostr pour HACKATHON...');
                loadNostrMerchants('HACKATHON');
                
            } catch (e) {
                logError('loadData', 'Erreur lors du chargement', e);
                document.getElementById('markets-list').innerHTML = '<p style="color: var(--text-muted);">Impossible de charger les march√©s</p>';
            }
        }
        
        // ============================================
        // CHARGEMENT MARCHANDS NOSTR
        // ============================================
        async function loadNostrMerchants(marketName) {
            logInfo('loadNostrMerchants', `R√©cup√©ration des marchands pour: ${marketName}`);
            const merchantsDiv = document.getElementById('merchants-list');
            
            try {
                const url = `/api/nostr/marche/${marketName}`;
                logInfo('loadNostrMerchants', `Requ√™te: GET ${url}`);
                
                const response = await fetch(url);
                const data = await response.json();
                
                logInfo('loadNostrMerchants', `R√©ponse re√ßue: success=${data.success}`, data);
                
                if (data.success && data.data) {
                    const marcheData = data.data;
                    
                    // Mettre √† jour les stats de bons
                    const totalBons = marcheData.total_bons || 0;
                    const totalMerchants = marcheData.total_merchants || 0;
                    logSuccess('loadNostrMerchants', `${totalMerchants} marchands, ${totalBons} bons`);
                    
                    document.getElementById('stat-bons').textContent = totalBons;
                    
                    if (marcheData.merchants && marcheData.merchants.length > 0) {
                        logInfo('loadNostrMerchants', `Affichage de ${Math.min(marcheData.merchants.length, 6)} marchands`);
                        
                        marcheData.merchants.slice(0, 6).forEach((m, i) => {
                            logInfo('loadNostrMerchants', `  Marchand ${i+1}: ${m.name} (${m.bons_count || 0} bons, issuer: ${m.pubkey?.substring(0,16)}...)`);
                        });
                        
                        merchantsDiv.innerHTML = marcheData.merchants.slice(0, 6).map(m => `
                            <div class="merchant-card">
                                <div class="merchant-header">
                                    ${m.bons_count ? `<span class="merchant-bons-badge">${m.bons_count} bon${m.bons_count > 1 ? 's' : ''}</span>` : ''}
                                    ${m.picture
                                        ? `<img src="${m.picture}" alt="${m.name}" class="merchant-avatar" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">`
                                        : ''
                                    }
                                    <div class="merchant-avatar-placeholder" ${m.picture ? 'style="display:none;"' : ''}>üè™</div>
                                    <div class="merchant-name">${m.name || 'Marchand'}</div>
                                </div>
                                <div class="merchant-body">
                                    <p class="merchant-about">${m.about || 'Aucune description disponible'}</p>
                                    <div class="merchant-meta">
                                        ${m.nip05 ? `<span class="merchant-tag">‚úì ${m.nip05}</span>` : ''}
                                        ${m.website ? `<span class="merchant-tag">üåê Site web</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        logSuccess('loadNostrMerchants', 'Marchands affich√©s avec succ√®s');
                    } else {
                        logWarn('loadNostrMerchants', 'Aucun marchand trouv√© dans les donn√©es Nostr');
                        merchantsDiv.innerHTML = `
                            <div class="card" style="grid-column: 1/-1; text-align: center;">
                                <p style="color: var(--text-secondary);">
                                    üè™ Aucun marchand d√©tect√© sur le relai Nostr.<br>
                                    <small>Les profils sont publi√©s via l'app Flutter (kind 0)</small>
                                </p>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                logError('loadNostrMerchants', 'Impossible de charger les donn√©es Nostr', e);
                merchantsDiv.innerHTML = `
                    <div class="card" style="grid-column: 1/-1; text-align: center;">
                        <p style="color: var(--warning);">
                            ‚ö†Ô∏è Impossible de charger les donn√©es Nostr<br>
                            <small style="color: var(--text-muted);">V√©rifiez que le relai Strfry est actif (ws://127.0.0.1:7777)</small>
                        </p>
                    </div>
                `;
            }
        }

        // ============================================
        // FEEDBACK FORM
        // ============================================
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('fbSubmitBtn');
            const status = document.getElementById('fbStatus');
            
            logInfo('Feedback', 'Soumission du formulaire de feedback');
            
            btn.disabled = true;
            btn.style.opacity = "0.7";
            btn.textContent = 'Envoi en cours...';
            status.innerHTML = '';

            const payload = {
                type: document.getElementById('fbType').value,
                title: document.getElementById('fbTitle').value,
                description: document.getElementById('fbDesc').value,
                email: document.getElementById('fbEmail').value,
                platform: 'Web Interface',
                app_version: document.getElementById('apk-version').textContent
            };
            
            logInfo('Feedback', `Type: ${payload.type}, Titre: ${payload.title}`, payload);

            try {
                const res = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();

                if (data.success) {
                    logSuccess('Feedback', `Issue GitHub cr√©√©e: #${data.issue_number}`, data);
                    status.innerHTML = `<span style="color: var(--success)">‚úÖ Feedback envoy√© (Issue #${data.issue_number})</span>`;
                    document.getElementById('feedbackForm').reset();
                } else {
                    let msg = data.error;
                    if(msg.includes('404')) msg = "Erreur configuration GitHub (Repo introuvable)";
                    logError('Feedback', msg, data);
                    status.innerHTML = `<span style="color: var(--error)">‚ùå ${msg}</span>`;
                }
            } catch (err) {
                logError('Feedback', 'Erreur r√©seau', err);
                status.innerHTML = `<span style="color: var(--error)">‚ùå Erreur r√©seau</span>`;
            } finally {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.textContent = 'Envoyer le feedback';
            }
        });

        // ============================================
        // D√âMARRAGE
        // ============================================
        logInfo('App', 'D√©marrage du chargement des donn√©es...');
        loadData();
    </script>
</body>
</html>
