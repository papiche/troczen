<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrocZen - Monnaie Locale Libre</title>
    <style>
        :root {
            --primary: #FFB347;
            --primary-dark: #e09220;
            --secondary: #0A7EA4;
            --bg-light: #f8f9fa;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* --- HERO SECTION --- */
        .hero {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d3436 100%);
            color: white;
            padding: 80px 20px;
            text-align: center;
            border-bottom-left-radius: 50px;
            border-bottom-right-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .logo { font-size: 4rem; margin-bottom: 10px; display: block; }
        h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 800; letter-spacing: -1px; }
        .subtitle { font-size: 1.2rem; opacity: 0.8; max-width: 600px; margin: 0 auto 40px; }

        .cta-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: #1e1e1e;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.4);
        }

        .btn-secondary {
            background-color: rgba(255,255,255,0.1);
            color: white;
            backdrop-filter: blur(5px);
        }

        .btn:hover { transform: translateY(-2px); }

        /* --- CONTENT CONTAINER --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* --- CARDS GRID --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 60px;
        }

        .card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .card:hover { transform: translateY(-3px); }

        .card h3 { margin-bottom: 10px; color: var(--secondary); }
        .card p { color: var(--text-light); font-size: 0.95rem; margin-bottom: 15px; }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-dark);
        }

        /* --- FEEDBACK FORM --- */
        .feedback-box {
            background: white;
            border-radius: var(--radius);
            padding: 30px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; margin-bottom: 15px; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f9f9f9;
            font-family: inherit;
            font-size: 0.95rem;
        }

        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--secondary);
            background: white;
        }

        /* --- DEV ZONE (Dark Theme) --- */
        .dev-zone {
            background: #1e1e1e;
            color: #bdc3c7;
            padding: 60px 20px;
            margin-top: 60px;
        }

        .dev-header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        .endpoint {
            background: #2d3436;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .method {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
        }
        .get { background: #27ae60; color: white; }
        .post { background: #2980b9; color: white; }

        .url { color: #ecf0f1; }
        .desc { color: #7f8c8d; font-size: 0.9em; margin-left: auto; }

        /* --- UTILS --- */
        .badge {
            background: #e1f5fe; color: #0288d1;
            padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold;
        }
        .hidden { display: none; }
        
        /* QR Code Overlay */
        #qrOverlay {
            margin-top: 20px;
            background: white;
            padding: 15px;
            border-radius: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>

    <!-- HERO USER -->
    <div class="hero">
        <span class="logo">üåª</span>
        <h1>TrocZen API</h1>
        <p class="subtitle">L'infrastructure d√©centralis√©e pour vos √©changes locaux.</p>
        
        <div class="cta-group">
            <a href="/api/apk/latest" class="btn btn-primary">
                ‚¨áÔ∏è T√©l√©charger l'App (APK)
            </a>
            <button onclick="toggleQR()" class="btn btn-secondary">
                üì± QR Code
            </button>
        </div>

        <div id="qrOverlay" class="hidden">
            <img src="/api/apk/qr" alt="QR Code" width="150" height="150">
            <p style="color:#333; font-size:0.8rem; margin-top:5px">Scannez pour installer</p>
        </div>
    </div>

    <div class="container">
        <!-- STATS & MARCH√âS -->
        <div class="section-title">
            <span>üìä</span> √âtat du r√©seau
        </div>
        
        <div class="grid">
            <div class="card">
                <h3>March√©s Actifs</h3>
                <div class="stat-number" id="stat-markets">-</div>
                <p>D√©tect√©s via Nostr</p>
                <div id="markets-list" style="font-size: 0.9em;"></div>
            </div>
            
            <div class="card">
                <h3>Commer√ßants</h3>
                <div class="stat-number" id="stat-profiles">-</div>
                <p>Profils synchronis√©s</p>
            </div>

            <div class="card">
                <h3>Version APK</h3>
                <div class="stat-number" style="font-size: 1.5rem;" id="apk-version">...</div>
                <p id="apk-size" style="margin-bottom:0">Taille: -</p>
            </div>
        </div>

        <!-- FEEDBACK -->
        <div class="section-title">
            <span>üí¨</span> Support & Feedback
        </div>
        
        <div class="feedback-box">
            <p style="margin-bottom: 20px;">Un bug ? Une suggestion ? Dites-le nous directement.</p>
            <form id="feedbackForm">
                <div class="form-row">
                    <div class="form-group">
                        <select id="fbType">
                            <option value="bug">üêõ Signaler un bug</option>
                            <option value="feature">‚ú® Sugg√©rer une id√©e</option>
                            <option value="question">‚ùì Question</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <input type="text" id="fbTitle" placeholder="Sujet du message..." required>
                    </div>
                </div>
                
                <div class="form-group">
                    <textarea id="fbDesc" rows="4" placeholder="D√©tails (contexte, √©tapes pour reproduire...)" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <input type="email" id="fbEmail" placeholder="Votre email (optionnel)">
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary" style="width: 100%; border-radius: 8px;" id="fbSubmitBtn">Envoyer</button>
                    </div>
                </div>
                <div id="fbStatus"></div>
            </form>
        </div>
    </div>

    <!-- DEV ZONE -->
    <div class="dev-zone">
        <div class="container">
            <div class="dev-header">
                <h2>üõ†Ô∏è Zone D√©veloppeurs</h2>
                <p>Documentation des endpoints API & Statut des services</p>
            </div>

            <div class="grid">
                <div>
                    <h3>Distribution</h3>
                    <div class="endpoint">
                        <span class="method get">GET</span>
                        <span class="url">/api/apk/latest</span>
                    </div>
                    <div class="endpoint">
                        <span class="method get">GET</span>
                        <span class="url">/api/apk/qr</span>
                    </div>
                </div>

                <div>
                    <h3>Nostr & Data</h3>
                    <div class="endpoint">
                        <span class="method get">GET</span>
                        <span class="url">/api/nostr/marche/:id</span>
                    </div>
                    <div class="endpoint">
                        <span class="method post">POST</span>
                        <span class="url">/api/upload/image</span>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px; font-size: 0.9em; opacity: 0.6;">
                Backend v1.0.0 ‚Ä¢ IPFS Enabled ‚Ä¢ Nostr Relay Connected
            </div>
        </div>
    </div>

    <script>
        // Toggle QR Code
        function toggleQR() {
            const qr = document.getElementById('qrOverlay');
            qr.classList.toggle('hidden');
        }

        // Chargement des donn√©es
        async function loadData() {
            try {
                // Stats
                const statsRes = await fetch('/api/stats');
                const stats = await statsRes.json();
                
                document.getElementById('stat-markets').textContent = stats.market_count;
                document.getElementById('stat-profiles').textContent = stats.profile_count;

                // Liste des march√©s
                const marketsDiv = document.getElementById('markets-list');
                if (stats.markets && stats.markets.length > 0) {
                    marketsDiv.innerHTML = stats.markets.map(m => 
                        `<a href="/market/${m}" class="badge" style="text-decoration:none; margin-right:5px;">${m}</a>`
                    ).join('');
                } else {
                    marketsDiv.textContent = "Aucun march√© d√©tect√©";
                }

                // Info APK
                const apkRes = await fetch('/api/apk/latest');
                if (apkRes.ok) {
                    const apk = await apkRes.json();
                    document.getElementById('apk-version').textContent = apk.version;
                    document.getElementById('apk-size').textContent = 
                        `Taille: ${(apk.size / 1024 / 1024).toFixed(1)} MB`;
                }

            } catch (e) {
                console.error("Erreur chargement:", e);
            }
        }

        // Gestion Feedback
        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('fbSubmitBtn');
            const status = document.getElementById('fbStatus');
            
            btn.disabled = true;
            btn.textContent = 'Envoi...';
            status.innerHTML = '';

            const payload = {
                type: document.getElementById('fbType').value,
                title: document.getElementById('fbTitle').value,
                description: document.getElementById('fbDesc').value,
                email: document.getElementById('fbEmail').value,
                platform: 'Web Dashboard',
                app_version: document.getElementById('apk-version').textContent
            };

            try {
                const res = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const data = await res.json();

                if (data.success) {
                    status.innerHTML = `<div style="color: green; margin-top:10px; font-weight:bold;">‚úÖ Feedback envoy√© ! Issue #${data.issue_number}</div>`;
                    document.getElementById('feedbackForm').reset();
                } else {
                    // Gestion sp√©cifique de l'erreur 404 GitHub
                    let errorMsg = data.error;
                    if (data.error && data.error.includes('404')) {
                        errorMsg = "Erreur de configuration serveur (Repo GitHub introuvable). Contactez l'admin.";
                    }
                    status.innerHTML = `<div style="color: red; margin-top:10px;">‚ùå ${errorMsg}</div>`;
                }
            } catch (err) {
                status.innerHTML = `<div style="color: red; margin-top:10px;">‚ùå Erreur r√©seau</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Envoyer';
            }
        });

        // Init
        loadData();
    </script>
</body>
</html>