<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>·∫êEN ‚Äî Simulateur v4 ¬∑ Bon Z√©ro & Rachat Volontaire</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ===================== DESIGN SYSTEM TOKENS ===================== */
:root {
  --radius: 4px;
  --moss:       #3d6147;
  --moss-light: #5a8a67;
  --rust:       #c4521a;
  --gold:       #d4a017;
  --green:  #10b981;
  --blue:   #3b82f6;
  --amber:  #f59e0b;
  --red:    #ef4444;
  --violet: #8b5cf6;
  --orange: #f97316;
  --circ:   #fbbf24;
  --zero:   #22d3ee;
}

[data-theme="dark"] {
  --bg:      #04070c;
  --p1:      #07101a;
  --p2:      #0b1724;
  --bd:      #152535;
  --dim:     #1e3348;
  --dim2:    #3a5570;
  --text:    #b8ccdc;
  --nav-bg:  rgba(4,7,12,0.95);
  --border:  #152535;
  --surface: #07101a;
  --surface2:#0b1724;
  --ink:     #b8ccdc;
  --ink-soft:#3a5570;
  --chart-grid: #0b1520;
  --chart-axis: #152535;
  --chart-label:#1e3348;
}
[data-theme="light"] {
  --bg:      #f5f0e8;
  --p1:      #ede5d0;
  --p2:      #e5dcc8;
  --bd:      rgba(122,92,58,0.2);
  --dim:     rgba(122,92,58,0.15);
  --dim2:    #7a6d55;
  --text:    #1c1a14;
  --nav-bg:  rgba(245,240,232,0.95);
  --border:  rgba(122,92,58,0.2);
  --surface: #ede5d0;
  --surface2:#e5dcc8;
  --ink:     #1c1a14;
  --ink-soft:#7a6d55;
  --chart-grid: #e5dcc8;
  --chart-axis: rgba(122,92,58,0.2);
  --chart-label:rgba(122,92,58,0.4);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Mono', monospace;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  font-size: 12px;
  transition: background 0.3s, color 0.3s;
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav {
  padding: 10px 20px;
  border-bottom: 1px solid var(--bd);
  display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  background: var(--nav-bg);
  backdrop-filter: blur(12px);
  position: sticky; top: 0; z-index: 100;
  transition: background 0.3s;
}
.nav-logo {
  font-family: 'Playfair Display', serif;
  font-weight: 900; font-size: 1.2rem;
  color: var(--moss); text-decoration: none;
  flex-shrink: 0;
}
.nav-logo span { color: var(--rust); }
.nav-links { display: flex; gap: 14px; list-style: none; align-items: center; }
.nav-links a { font-size: 0.6rem; font-weight: 500; color: var(--dim2); text-decoration: none; letter-spacing: 0.04em; transition: color 0.2s; }
.nav-links a:hover { color: var(--moss); }
.nav-links a.active { color: var(--green); font-weight: 700; }

.nav-spacer { flex: 1; }

.chips { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.chip { padding: 0.18rem 0.55rem; border-radius: 3px; font-size: 0.55rem; font-weight: 600; letter-spacing: 0.06em; border: 1px solid; cursor: default; }
.chip-ok   { color: var(--green); border-color: #10b98135; background: #10b98108; }
.chip-no   { color: var(--red);   border-color: #ef444435; background: #ef444408; }
.chip-new  { color: var(--zero);  border-color: #22d3ee35; background: #22d3ee08; }
.chip-hmac { color: var(--violet);border-color: #8b5cf635; background: #8b5cf608; }

.theme-toggle {
  background: var(--p2); border: 1px solid var(--bd);
  color: var(--text); width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 14px; flex-shrink: 0;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout { flex: 1; display: grid; grid-template-columns: 260px 1fr; min-height: 0; }

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.side { background: var(--p1); border-right: 1px solid var(--bd); padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.1rem; }
.sh { font-size: 0.52rem; letter-spacing: 0.2em; text-transform: uppercase; color: var(--dim2); border-bottom: 1px solid var(--bd); padding-bottom: 0.3rem; margin-bottom: 0.45rem; }

.actors { display: flex; flex-direction: column; gap: 0.45rem; }
.actor { border: 1px solid var(--bd); border-radius: 4px; padding: 0.55rem 0.65rem; background: var(--p2); transition: border-color 0.15s; cursor: default; }
.actor.on { border-color: var(--ac); }
.a-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem; }
.a-name { display: flex; align-items: center; gap: 0.4rem; font-weight: 700; font-size: 0.72rem; }
.dot { width: 7px; height: 7px; border-radius: 50%; background: var(--ac); box-shadow: 0 0 6px var(--ac); cursor: pointer; flex-shrink: 0; }
.a-badge { font-size: 0.58rem; font-weight: 700; color: var(--ac); background: color-mix(in srgb, var(--ac) 10%, transparent); border: 1px solid color-mix(in srgb, var(--ac) 25%, transparent); padding: 0.08rem 0.38rem; border-radius: 3px; }
.row { display: flex; align-items: center; gap: 0.45rem; margin-bottom: 0.25rem; }
.rl { font-size: 0.56rem; color: var(--dim2); width: 22px; flex-shrink: 0; }
.rl.r { text-align: right; }

input[type=range].sl { flex: 1; -webkit-appearance: none; height: 3px; background: linear-gradient(to right, color-mix(in srgb, var(--ac) 25%, var(--dim)), var(--ac)); border-radius: 2px; outline: none; }
input[type=range].sl::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--ac); cursor: pointer; box-shadow: 0 0 6px var(--ac); }
input[type=range].gsl { width: 100%; -webkit-appearance: none; height: 2px; background: var(--bd); outline: none; border-radius: 1px; }
input[type=range].gsl::-webkit-slider-thumb { -webkit-appearance: none; width: 11px; height: 11px; border-radius: 50%; background: var(--circ); cursor: pointer; box-shadow: 0 0 5px var(--circ); }

.a-sub { font-size: 0.56rem; color: var(--dim2); font-style: italic; }
.gp { margin-bottom: 0.65rem; }
.gl { display: flex; justify-content: space-between; font-size: 0.6rem; margin-bottom: 0.28rem; }
.gv { color: var(--circ); font-family: 'DM Mono', monospace; font-weight: 700; }

.ibox { background: var(--bg); border: 1px solid var(--bd); border-radius: 3px; padding: 0.65rem; font-size: 0.58rem; line-height: 1.8; color: var(--dim2); }
.ibox .ok  { color: var(--green); font-weight: 600; }
.ibox .no  { color: var(--red);   font-weight: 600; }
.ibox .hi  { color: var(--zero);  font-weight: 600; }
.ibox code { font-family: 'DM Mono', monospace; background: var(--p2); padding: 0.03rem 0.28rem; border-radius: 2px; font-size: 0.62rem; color: var(--green); }

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main { overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.9rem; }

.stats { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--bd); border: 1px solid var(--bd); border-radius: 3px; overflow: hidden; }
.st { background: var(--p1); padding: 0.55rem 0.6rem; text-align: center; }
.sv { font-family: 'DM Mono', monospace; font-weight: 700; font-size: 1rem; display: block; }
.sl2 { font-size: 0.48rem; color: var(--dim2); text-transform: uppercase; letter-spacing: 0.07em; }

.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.9rem; }
.card { background: var(--p1); border: 1px solid var(--bd); border-radius: 4px; padding: 0.85rem; position: relative; }
.card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--ca,var(--green)); border-radius:4px 4px 0 0; }
.wide { grid-column: 1/-1; }
.ct { font-size: 0.52rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--dim2); margin-bottom: 0.55rem; }

canvas { display: block; width: 100% !important; }

.phases { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.6rem; margin-bottom: 0.3rem; }
.phase { background: var(--p2); border: 1px solid var(--bd); border-radius: 3px; padding: 0.5rem 0.6rem; border-top: 2px solid var(--pc); }
.ph-title { font-size: 0.58rem; font-weight: 700; color: var(--pc); margin-bottom: 0.2rem; }
.ph-body  { font-size: 0.55rem; color: var(--dim2); line-height: 1.6; }

.log { max-height: 130px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.22rem; scrollbar-width: thin; }
.le { font-size: 0.56rem; line-height: 1.5; padding: 0.22rem 0.45rem; border-radius: 2px; animation: fu 0.2s ease; }
.le-circ    { background: color-mix(in srgb, var(--circ) 5%, transparent); border: 1px solid color-mix(in srgb, var(--circ) 18%, transparent); }
.le-buyback { background: color-mix(in srgb, var(--violet) 5%, transparent); border: 1px solid color-mix(in srgb, var(--violet) 20%, transparent); }
.le-exp     { background: color-mix(in srgb, var(--red) 4%, transparent); border: 1px solid color-mix(in srgb, var(--red) 15%, transparent); }
.le-zero    { background: color-mix(in srgb, var(--zero) 5%, transparent); border: 1px solid color-mix(in srgb, var(--zero) 20%, transparent); }
@keyframes fu { from{opacity:0;transform:translateY(3px);}to{opacity:1;transform:none;} }

.hmac-vis { display: flex; flex-direction: column; gap: 0.35rem; }
.hv-path { display: flex; align-items: center; gap: 0.3rem; font-size: 0.56rem; padding: 0.3rem 0.5rem; background: var(--p2); border: 1px solid var(--bd); border-radius: 3px; }
.hv-hop { display: flex; flex-direction: column; align-items: center; gap: 0.1rem; }
.hv-dot { width: 10px; height: 10px; border-radius: 50%; }
.hv-label { font-size: 0.48rem; color: var(--dim2); }
.hv-arrow { color: var(--dim2); font-size: 0.7rem; margin: 0 0.1rem; }
.hv-hash { font-size: 0.46rem; color: var(--violet); font-family: 'DM Mono', monospace; }

.leg { display: flex; gap: 0.7rem; flex-wrap: wrap; font-size: 0.56rem; margin-top: 0.4rem; }
.li { display: flex; align-items: center; gap: 0.28rem; }
.ld { width: 16px; height: 2px; border-radius: 1px; }

@media (max-width: 860px) {
  .layout { grid-template-columns: 1fr; }
  .grid { grid-template-columns: 1fr; }
  .stats { grid-template-columns: repeat(4, 1fr); }
  .phases { grid-template-columns: 1fr 1fr; }
  .nav-links { display: none; }
}
</style>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">·∫êEN<span>¬∑</span></a>
  <ul class="nav-links">
    <li><a href="/">Accueil</a></li>
    <li><a href="/boucles">Sch√©ma</a></li>
    <li><a href="/simulateur" class="active">Simulateur</a></li>
    <li><a href="/monitor">Monitor</a></li>
  </ul>
  <div class="chips">
    <div class="chip chip-new">‚ú¶ Bon Z√©ro ‚Äî premier bon gratuit pour lancer le r√©seau</div>
    <div class="chip chip-ok">‚úì Dur√©e de vie limit√©e (max 365 jours)</div>
    <div class="chip chip-ok">‚úì Rachat volontaire avant expiration</div>
    <div class="chip chip-hmac">‚¨° Identit√©s des porteurs prot√©g√©es</div>
    <div class="chip chip-no">‚úó Pas de fractionnement ¬∑ Pas de prolongation</div>
  </div>
  <div class="nav-spacer"></div>
  <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn">‚òÄÔ∏è</button>
</nav>

<div class="layout">
  <aside class="side">
    <div>
      <div class="sh">Acteurs du march√©</div>
      <div class="actors" id="actor-list"></div>
    </div>
    <div>
      <div class="sh">Param√®tres de simulation</div>
      <div class="gp"><div class="gl">Jours simul√©s <span class="gv" id="v-days">300</span></div><input type="range" class="gsl" id="sl-days" min="60" max="720" step="10" value="300"></div>
      <div class="gp"><div class="gl">Intensit√© des √©changes <span class="gv" id="v-c2">0.07</span></div><input type="range" class="gsl" id="sl-c2" min="0.02" max="0.20" step="0.01" value="0.07"></div>
      <div class="gp"><div class="gl">Vitesse d'√©change <span class="gv" id="v-speed">0.5</span></div><input type="range" class="gsl" id="sl-speed" min="0.1" max="2.0" step="0.1" value="0.5"></div>
      <div class="gp"><div class="gl">Fr√©quence des retours <span class="gv" id="v-dens">0.5</span></div><input type="range" class="gsl" id="sl-dens" min="0.1" max="1.5" step="0.1" value="0.5"></div>
      <div class="gp"><div class="gl">Rachat volontaire avant expiration <span class="gv" id="v-buyback">40</span>%</div><input type="range" class="gsl" id="sl-buyback" min="0" max="100" step="5" value="40"></div>
    </div>
    <div>
      <div class="sh">R√®gles du protocole</div>
      <div class="ibox">
        <span class="hi">‚óè</span> <b>Bon Z√©ro</b> : gratuit, valide 28 jours<br>
        &nbsp;&nbsp;‚Üí cr√©e des liens de confiance √† chaque passage<br>
        &nbsp;&nbsp;‚Üí active le cr√©dit quotidien d√®s 5 contacts atteints<br><br>
        <span class="ok">‚úì</span> La date d'expiration ne change jamais<br>
        <span class="ok">‚úì</span> Chaque transfert incr√©mente le compteur de passages<br>
        <span class="ok">‚úì</span> Retour au cr√©ateur = bon utilis√©, parcours r√©v√©l√©<br>
        <span class="no">‚úó</span> Pas de division ¬∑ Pas de prolongation<br><br>
        <span style="color:var(--violet)">‚¨°</span> Le parcours est enregistr√© de fa√ßon anonyme<br>
        &nbsp;&nbsp;Seul le cr√©ateur peut reconstituer qui a port√© le bon
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="stats" id="stats"></div>
    <div class="phases">
      <div class="phase" style="--pc: var(--zero)"><div class="ph-title">‚ë† D√©marrage</div><div class="ph-body">Bon Z√©ro circule gratuitement<br>Les liens de confiance se cr√©ent<br>5 contacts pour activer le cr√©dit</div></div>
      <div class="phase" style="--pc: var(--green)"><div class="ph-title">‚ë° Premier cr√©dit</div><div class="ph-body">Les premiers bons de valeur circulent<br>La masse totale se stabilise<br>Le march√© commence √† vivre</div></div>
      <div class="phase" style="--pc: var(--amber)"><div class="ph-title">‚ë¢ Circulation active</div><div class="ph-body">Les bons reviennent aux cr√©ateurs<br>Rachats avant expiration<br>Plus de bons utilis√©s qu'expir√©s</div></div>
      <div class="phase" style="--pc: var(--violet)"><div class="ph-title">‚ë£ March√© mature</div><div class="ph-body">Les habitudes d'√©change se r√©v√®lent<br>Les r√¥les de chacun √©mergent<br>Le march√© devient autonome</div></div>
    </div>
    <div class="grid">
      <div class="card wide" style="--ca: var(--green)"><div class="ct">üìä Bons ·∫êEN en circulation ¬∑ avec phase de d√©marrage Bon Z√©ro (28 premiers jours)</div><canvas id="c-mass" height="190"></canvas><div class="leg" id="leg"></div></div>
      <div class="card" style="--ca: var(--zero)"><div class="ct">üå± Propagation Bon Z√©ro ¬∑ contacts par personne (5 contacts = activation du cr√©dit)</div><canvas id="c-n1" height="165"></canvas></div>
      <div class="card" style="--ca: var(--circ)"><div class="ct">üîÅ Bons utilis√©s : retours organiques vs rachats volontaires</div><canvas id="c-circ" height="165"></canvas></div>
      <div class="card" style="--ca: var(--red)"><div class="ct">‚öñÔ∏è Flux : cr√©ation / expiration / sauv√©s par rachat</div><canvas id="c-flow" height="165"></canvas></div>
      <div class="card" style="--ca: var(--amber)"><div class="ct">‚ù§Ô∏è Sant√© du march√© (bons utilis√©s / bons expir√©s) ¬∑ au-dessus de 1,0 = march√© vivant</div><canvas id="c-health" height="165"></canvas></div>
      <div class="card" style="--ca: var(--violet)"><div class="ct">‚¨° Confidentialit√© du parcours ¬∑ ce que voit le cr√©ateur vs un tiers</div><div class="hmac-vis" id="hmac-vis" style="margin-top:0.4rem"></div></div>
      <div class="card wide" style="--ca: var(--circ)"><div class="ct">üìú Journal des √©v√©nements ¬∑ bons utilis√©s, rachats, d√©marrages, expirations</div><div class="log" id="log"></div></div>
    </div>
  </main>
</div>

<script>
/* ‚îÄ‚îÄ THEME ‚îÄ‚îÄ */
function getTheme() { try { return localStorage.getItem('zen-theme') || 'dark'; } catch(e) { return 'dark'; } }
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeBtn').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  try { localStorage.setItem('zen-theme', t); } catch(e) {}
  if (typeof render === 'function') render();
}
function toggleTheme() { setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
setTheme(getTheme());

/* ‚îÄ‚îÄ ACTORS ‚îÄ‚îÄ */
const ACTORS = [
  { id:'alice',  name:'Alice',  color:'#10b981', ttl:28,  spend:0.80, n1:(t,s)=>Math.min(6+Math.floor(t*0.06*s),18), n2r:(n1,d)=>n1*7*d },
  { id:'bob',    name:'Bob',    color:'#f97316', ttl:7,   spend:0.95, n1:(t,s)=>Math.min(5+Math.floor(t*0.10*s),28), n2r:(n1,d)=>n1*3*d },
  { id:'carol',  name:'Carol',  color:'#818cf8', ttl:90,  spend:0.30, n1:(t,s)=>Math.min(5+Math.floor(t*0.03*s),10), n2r:(n1,d)=>n1*11*d },
  { id:'dave',   name:'Dave',   color:'#f43f5e', ttl:180, spend:0.15, n1:(t,s)=>Math.min(5+Math.floor(t*0.01*s),7),  n2r:(n1,d)=>n1*2*d },
  { id:'eve',    name:'Eve',    color:'#fbbf24', ttl:45,  spend:0.65, n1:(t,s)=>Math.min(7+Math.floor(t*0.07*s),20), n2r:(n1,d)=>n1*6*d },
];

let active = new Set(ACTORS.map(a=>a.id));
let eventLog = [];

/* ‚îÄ‚îÄ SIMULATION ‚îÄ‚îÄ */
function simulate(C2, days, speed, dens, buybackRate) {
  eventLog = [];
  const res = {};
  ACTORS.forEach(actor => {
    const massArr=[], n1Arr=[], circOrg=[], circBuy=[], expArr=[], savedArr=[], flowCreation=[], healthArr=[];
    let bonds=[], totalOrg=0, totalBuy=0, totalExp=0, totalSaved=0, totalCreated=0;
    const zeroBondActive = (t) => t <= 28;
    for (let t=0; t<=days; t++) {
      const n1 = actor.n1(t, speed);
      const n2 = Math.floor(actor.n2r(n1, dens));
      let expiredVal=0;
      bonds = bonds.filter(b => { if (b.expiresAt<=t) { expiredVal+=b.val; totalExp+=b.val; return false; } return true; });
      let savedVal=0;
      const alertBonds = bonds.filter(b => b.expiresAt-t<=3 && b.expiresAt>t && !b.buybackAttempted);
      alertBonds.forEach(b => {
        b.buybackAttempted=true;
        if (Math.random() < buybackRate) {
          totalBuy++; totalSaved+=b.val; savedVal+=b.val; bonds.splice(bonds.indexOf(b),1);
          if (eventLog.length<80) eventLog.push({ t, type:'buyback', actor:actor.name, color:actor.color, val:b.val.toFixed(1), age:t-b.issuedAt, residual:b.expiresAt-t });
        }
      });
      let du=0;
      if (n1>=5) {
        const lm = bonds.reduce((s,b)=>s+b.val,0);
        const sqN2 = Math.sqrt(Math.max(n2,1));
        du = Math.max(0, Math.min(C2*(lm*0.55+lm*0.28/sqN2)/(n1+sqN2), 35));
        const nb=Math.max(1, Math.round(du/5));
        for (let k=0;k<nb;k++) bonds.push({ val:du/nb, issuedBy:actor.id, issuedAt:t, expiresAt:t+actor.ttl, hops:0, buybackAttempted:false });
        totalCreated+=du;
      }
      const toPass = Math.floor(bonds.length*actor.spend*0.07);
      for (let k=0; k<toPass; k++) {
        if (!bonds.length) break;
        const idx=Math.floor(Math.random()*bonds.length);
        const b=bonds[idx];
        const loopP=Math.min(0.03+(n2/(n1*18+1))*0.18, 0.25);
        if (Math.random()<loopP) {
          totalOrg++;
          if (eventLog.length<80) eventLog.push({ t, type:'circuit', actor:actor.name, color:actor.color, val:b.val.toFixed(1), age:t-b.issuedAt, hops:b.hops+1, residual:Math.max(0,b.expiresAt-t), ttl:actor.ttl });
          bonds.splice(idx,1);
        } else { b.hops++; }
      }
      if (zeroBondActive(t) && t>0 && t%5===0 && n1<5 && eventLog.length<80)
        eventLog.push({ t, type:'zero', actor:actor.name, color:'#22d3ee', n1, msg:`Bon Z√©ro actif ‚Äî N1=${n1}/5` });
      const lm=bonds.reduce((s,b)=>s+b.val,0);
      const health=(totalOrg+totalBuy)/Math.max((totalExp/Math.max(t,1))*30+0.01, 0.01);
      massArr.push(Math.round(lm*10)/10); n1Arr.push(n1);
      circOrg.push(totalOrg); circBuy.push(totalBuy);
      expArr.push(Math.round(totalExp*10)/10); savedArr.push(Math.round(totalSaved*10)/10);
      flowCreation.push(Math.round(du*100)/100); healthArr.push(Math.min(Math.round(health*100)/100, 5));
    }
    res[actor.id]={ massArr,n1Arr,circOrg,circBuy,expArr,savedArr,flowCreation,healthArr, totOrg:totalOrg,totBuy:totalBuy,totExp:totalExp,totSaved:totalSaved };
  });
  return res;
}

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
class Chart {
  constructor(id,h){ this.cv=document.getElementById(id); this.ctx=this.cv.getContext('2d'); this.dpr=devicePixelRatio||1; this.H=h; this.pad={t:10,r:12,b:26,l:44}; this.resize(); }
  resize(){
    const w=this.cv.parentElement.clientWidth-28;
    this.W=w; this.cv.width=w*this.dpr; this.cv.height=this.H*this.dpr;
    this.cv.style.width=w+'px'; this.cv.style.height=this.H+'px';
    this.ctx.scale(this.dpr,this.dpr);
    this.pw=w-this.pad.l-this.pad.r; this.ph=this.H-this.pad.t-this.pad.b;
  }
  draw(datasets,xL,refLine){
    const {ctx,pad,pw,ph}=this;
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const gridColor = isDark ? '#0b1520' : '#e5dcc8';
    const axisColor = isDark ? '#152535' : 'rgba(122,92,58,0.2)';
    const labelColor = isDark ? '#1e3348' : 'rgba(122,92,58,0.4)';
    ctx.clearRect(0,0,this.W,this.H);
    let mn=Infinity,mx=-Infinity;
    datasets.forEach(ds=>{ if(!ds.vis)return; (ds.data||[]).forEach(v=>{ if(isFinite(v)){if(v<mn)mn=v;if(v>mx)mx=v;} }); });
    if(refLine!=null){if(refLine<mn)mn=refLine;if(refLine>mx)mx=refLine;}
    if(!isFinite(mn)){mn=0;mx=1;} if(mn===mx)mx=mn+1; mn=Math.min(0,mn);
    const yr=mx-mn;
    const px=i=>pad.l+(i/Math.max((datasets[0]?.data?.length||2)-1,1))*pw;
    const py=v=>pad.t+ph-((v-mn)/yr)*ph;
    for(let i=0;i<=4;i++){
      const y=pad.t+ph-(i/4)*ph;
      ctx.strokeStyle=gridColor;ctx.lineWidth=1;
      ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(pad.l+pw,y);ctx.stroke();
      ctx.fillStyle=labelColor;ctx.font='9px DM Mono, monospace';ctx.textAlign='right';
      ctx.fillText(fv(mn+(i/4)*yr),pad.l-4,y+3);
    }
    if(xL){ ctx.fillStyle=labelColor;ctx.font='9px DM Mono, monospace';ctx.textAlign='center'; const step=Math.ceil(xL.length/5); xL.forEach((l,i)=>{if(i%step!==0)return;ctx.fillText(l,pad.l+(i/(xL.length-1))*pw,pad.t+ph+18);}); }
    ctx.strokeStyle=axisColor;ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(pad.l,pad.t);ctx.lineTo(pad.l,pad.t+ph);ctx.lineTo(pad.l+pw,pad.t+ph);ctx.stroke();
    if(refLine!=null){ ctx.strokeStyle='rgba(255,255,255,0.15)';ctx.lineWidth=1;ctx.setLineDash([4,4]); ctx.beginPath();ctx.moveTo(pad.l,py(refLine));ctx.lineTo(pad.l+pw,py(refLine));ctx.stroke(); ctx.setLineDash([]); ctx.fillStyle='rgba(255,255,255,0.3)';ctx.font='8px DM Mono, monospace';ctx.textAlign='left'; ctx.fillText(fv(refLine),pad.l+3,py(refLine)-3); }
    datasets.forEach(ds=>{
      if(!ds.vis)return;
      const data=ds.data||[];
      if(ds.fill){ ctx.beginPath();ctx.moveTo(px(0),pad.t+ph); data.forEach((v,i)=>ctx.lineTo(px(i),py(v))); ctx.lineTo(px(data.length-1),pad.t+ph);ctx.closePath(); ctx.fillStyle=ds.color+'12';ctx.fill(); }
      ctx.beginPath();ctx.strokeStyle=ds.color;ctx.lineWidth=ds.lw||2;ctx.lineJoin='round';
      if(ds.dash)ctx.setLineDash(ds.dash);else ctx.setLineDash([]);
      let first=true;
      data.forEach((v,i)=>{ const x=px(i),y=py(v); first?(ctx.moveTo(x,y),first=false):ctx.lineTo(x,y); });
      ctx.stroke();ctx.setLineDash([]);
      const lv=data[data.length-1];
      if(isFinite(lv)){ ctx.save();ctx.shadowColor=ds.color;ctx.shadowBlur=8; ctx.beginPath();ctx.arc(px(data.length-1),py(lv),3,0,Math.PI*2);ctx.fillStyle=ds.color;ctx.fill();ctx.restore(); }
    });
  }
}

function fv(v){const a=Math.abs(v);if(a>=10000)return(v/1e3).toFixed(0)+'k';if(a>=1000)return(v/1e3).toFixed(1)+'k';return Math.round(v).toString();}

/* ‚îÄ‚îÄ HMAC VIZ ‚îÄ‚îÄ */
function renderHMAC(actors){
  const container=document.getElementById('hmac-vis'); container.innerHTML='';
  const actives=actors.filter(a=>active.has(a.id));
  if(actives.length<2){container.innerHTML='<div style="font-size:0.55rem;color:var(--dim2)">Activer au moins 2 acteurs</div>';return;}
  const path=actives.slice(0,Math.min(4,actives.length)); const bonId='bon_a3f8c2';
  const ivRow=document.createElement('div'); ivRow.className='hv-path';
  ivRow.innerHTML=`<span style="font-size:0.52rem;color:var(--green);font-weight:700;width:100px;flex-shrink:0">Cr√©ateur du bon :</span>`;
  path.forEach((a,i)=>{ const hop=document.createElement('div'); hop.className='hv-hop'; hop.innerHTML=`<div class="hv-dot" style="background:${a.color}"></div><div class="hv-label" style="color:${a.color}">${a.name}</div>`; ivRow.appendChild(hop); if(i<path.length-1){const arr=document.createElement('span');arr.className='hv-arrow';arr.textContent='‚Üí';ivRow.appendChild(arr);} });
  container.appendChild(ivRow);
  const tpRow=document.createElement('div'); tpRow.className='hv-path';
  tpRow.innerHTML=`<span style="font-size:0.52rem;color:var(--violet);font-weight:700;width:100px;flex-shrink:0">N'importe qui d'autre :</span>`;
  path.forEach((a,i)=>{ const hop=document.createElement('div'); hop.className='hv-hop'; const hash=btoa(a.id+bonId).substring(0,8)+'‚Ä¶'; hop.innerHTML=`<div class="hv-dot" style="background:var(--dim)"></div><div class="hv-hash">HMAC:${hash}</div>`; tpRow.appendChild(hop); if(i<path.length-1){const arr=document.createElement('span');arr.className='hv-arrow';arr.textContent='‚Üí';tpRow.appendChild(arr);} });
  container.appendChild(tpRow);
  const note=document.createElement('div'); note.style.cssText='font-size:0.52rem;color:var(--dim2);margin-top:0.3rem;line-height:1.6';
  note.innerHTML=`bon_id = <span style="color:var(--green)">${bonId}</span> ¬∑ Le parcours est enregistr√© de fa√ßon anonyme ¬∑ ${path.length} passages visibles, mais les noms restent cach√©s`;
  container.appendChild(note);
}

/* ‚îÄ‚îÄ UI ‚îÄ‚îÄ */
let charts={};
function ttlBadge(d){ return d<=7?`${d}j üü†`:d<=28?`${d}j üü¢`:d<=90?`${d}j üîµ`:d<365?`${d}j üü£`:`${d}j üî¥`; }

function initActors(){
  const list=document.getElementById('actor-list'); list.innerHTML='';
  ACTORS.forEach(a=>{
    const div=document.createElement('div'); div.className='actor on'; div.style.setProperty('--ac',a.color);
    div.innerHTML=`<div class="a-head"><div class="a-name"><div class="dot" id="dot-${a.id}"></div><span>${a.name}</span></div><div class="a-badge" id="badge-${a.id}">${ttlBadge(a.ttl)}</div></div><div class="row"><span class="rl">7j</span><input type="range" class="sl" id="ttl-${a.id}" min="7" max="365" step="1" value="${a.ttl}" style="--ac:${a.color}"><span class="rl r">365j</span></div><div class="row"><span class="rl">‚ö°</span><input type="range" class="sl" id="sp-${a.id}" min="0.05" max="1.0" step="0.05" value="${a.spend}" style="--ac:${a.color}"><span class="rl r" id="spv-${a.id}">${Math.round(a.spend*100)}%</span></div><div class="a-sub" id="sub-${a.id}">${desc(a)}</div>`;
    list.appendChild(div);
    document.getElementById(`ttl-${a.id}`).addEventListener('input',function(){ a.ttl=parseInt(this.value); document.getElementById(`badge-${a.id}`).textContent=ttlBadge(a.ttl); document.getElementById(`sub-${a.id}`).textContent=desc(a); render(); });
    document.getElementById(`sp-${a.id}`).addEventListener('input',function(){ a.spend=parseFloat(this.value); document.getElementById(`spv-${a.id}`).textContent=Math.round(a.spend*100)+'%'; render(); });
    document.getElementById(`dot-${a.id}`).addEventListener('click',()=>{ if(active.has(a.id)){ if(active.size<=1)return; active.delete(a.id); div.classList.remove('on'); } else { active.add(a.id); div.classList.add('on'); } render(); });
  });
}

function desc(a){ const d=[[7,'Urgentiste ‚Äî boucles < 7j'],[14,'Rapide ‚Äî march√© hebdo'],[28,'Standard ‚Äî mensuel'],[90,'Projet ‚Äî trimestriel'],[180,'Long ‚Äî semestriel'],[365,'Annuel ‚Äî max confiance']]; return d.reduce((p,c)=>Math.abs(c[0]-a.ttl)<Math.abs(p[0]-a.ttl)?c:p)[1]; }

function bindGlobal(){
  [['sl-days','v-days',0],['sl-c2','v-c2',2],['sl-speed','v-speed',1],['sl-dens','v-dens',1],['sl-buyback','v-buyback',0]].forEach(([id,vid,dec])=>{
    const sl=document.getElementById(id),vl=document.getElementById(vid);
    sl.addEventListener('input',()=>{ vl.textContent=parseFloat(sl.value).toFixed(dec); render(); });
  });
}

function render(){
  const days=+document.getElementById('sl-days').value;
  const C2=+document.getElementById('sl-c2').value;
  const speed=+document.getElementById('sl-speed').value;
  const dens=+document.getElementById('sl-dens').value;
  const buyback=+document.getElementById('sl-buyback').value/100;
  const data=simulate(C2,days,speed,dens,buyback);
  const labels=Array.from({length:days+1},(_,i)=>`J${i}`);
  const actives=ACTORS.filter(a=>active.has(a.id));
  charts.mass.draw(actives.map(a=>({ data:data[a.id].massArr, color:a.color, fill:true, lw:2, vis:true })),labels);
  charts.n1.draw([ ...actives.map(a=>({ data:data[a.id].n1Arr, color:a.color, fill:false, lw:2, vis:true })) ],labels,5);
  const circDs=[]; actives.forEach(a=>{ circDs.push({ data:data[a.id].circOrg, color:a.color, fill:false, lw:2, vis:true }); circDs.push({ data:data[a.id].circBuy, color:a.color, fill:false, lw:1, dash:[3,3], vis:true }); });
  charts.circ.draw(circDs,labels);
  const firstA=actives[0];
  charts.flow.draw([ { data:data[firstA.id].flowCreation, color:firstA.color, fill:true, lw:2, vis:true }, { data:data[firstA.id].expArr.map((_,i,arr)=>i>0?arr[i]-arr[i-1]:0), color:'#ef4444', fill:true, lw:1.5, dash:[4,3], vis:true }, { data:data[firstA.id].savedArr.map((_,i,arr)=>i>0?arr[i]-arr[i-1]:0), color:'#8b5cf6', fill:false, lw:1.5, vis:true } ],labels);
  charts.health.draw(actives.map(a=>({ data:data[a.id].healthArr, color:a.color, fill:false, lw:2, vis:true })),labels,1.0);
  const leg=document.getElementById('leg'); leg.innerHTML='';
  actives.forEach(a=>{ const item=document.createElement('div'); item.className='li'; item.innerHTML=`<div class="ld" style="background:${a.color}"></div><span style="color:${a.color}">${a.name} (${a.ttl}j)</span>`; leg.appendChild(item); });
  leg.innerHTML+=`<span style="color:var(--dim2);font-size:0.5rem">  ‚Äî ‚Äî : rachats volontaires</span>`;
  renderHMAC(ACTORS);
  const logEl=document.getElementById('log'); logEl.innerHTML='';
  const sorted=[...eventLog].sort((a,b)=>b.t-a.t).slice(0,30);
  if(!sorted.length){ logEl.innerHTML='<div style="font-size:0.56rem;color:var(--dim2)">Augmentez la densit√© des retours pour voir les √©v√©nements...</div>'; }
  else sorted.forEach(e=>{
    const div=document.createElement('div'); let cls='le ', txt='';
    if(e.type==='circuit'){ cls+='le-circ'; txt=`üîÅ <span style="color:${e.color};font-weight:600">${e.actor}</span> J${e.t} ¬∑ <span style="color:var(--circ)">${e.val}·∫êEN</span> ¬∑ ${e.hops} personnes ¬∑ ${e.age}j/${e.ttl}j ¬∑ reste ${e.residual}j`; }
    else if(e.type==='buyback'){ cls+='le-buyback'; txt=`üõí <span style="color:${e.color};font-weight:600">${e.actor}</span> RACHAT J${e.t} ¬∑ <span style="color:var(--violet)">${e.val}·∫êEN r√©cup√©r√©s</span> ¬∑ √¢ge ${e.age}j ¬∑ restait ${e.residual}j`; }
    else if(e.type==='zero'){ cls+='le-zero'; txt=`üå± <span style="color:#22d3ee;font-weight:600">${e.actor}</span> BON Z√âRO J${e.t} ¬∑ ${e.msg}`; }
    div.className=cls; div.innerHTML=txt; logEl.appendChild(div);
  });
  const totMass=actives.reduce((s,a)=>s+data[a.id].massArr[days],0);
  const totOrg=actives.reduce((s,a)=>s+data[a.id].totOrg,0);
  const totBuy=actives.reduce((s,a)=>s+data[a.id].totBuy,0);
  const totExp=actives.reduce((s,a)=>s+data[a.id].totExp,0);
  const totSaved=actives.reduce((s,a)=>s+data[a.id].totSaved,0);
  const activatedCount=actives.filter(a=>data[a.id].n1Arr[days]>=5).length;
  const avgHealth=actives.reduce((s,a)=>s+data[a.id].healthArr[days],0)/actives.length;
  document.getElementById('stats').innerHTML=`<div class="st"><span class="sv" style="color:var(--green)">${fv(totMass)}</span><span class="sl2">Bons en circulation</span></div><div class="st"><span class="sv" style="color:var(--circ)">${totOrg}</span><span class="sl2">Retours organiques</span></div><div class="st"><span class="sv" style="color:var(--violet)">${totBuy}</span><span class="sl2">Rachats volontaires</span></div><div class="st"><span class="sv" style="color:var(--red)">${fv(totExp)}</span><span class="sl2">Expir√©s sans usage</span></div><div class="st"><span class="sv" style="color:var(--violet)">${fv(totSaved)}</span><span class="sl2">Valeur sauv√©e</span></div><div class="st"><span class="sv" style="color:var(--zero)">${activatedCount}/${actives.length}</span><span class="sl2">Acteurs actifs</span></div><div class="st"><span class="sv" style="color:${avgHealth>=1?'var(--green)':'var(--amber)'}"> ${avgHealth.toFixed(2)}√ó</span><span class="sl2">Sant√© march√©</span></div>`;
}

document.fonts.ready.then(()=>{
  initActors(); bindGlobal();
  charts.mass   = new Chart('c-mass',  190);
  charts.n1     = new Chart('c-n1',    165);
  charts.circ   = new Chart('c-circ',  165);
  charts.flow   = new Chart('c-flow',  165);
  charts.health = new Chart('c-health',165);
  render();
  window.addEventListener('resize',()=>{ Object.values(charts).forEach(c=>c.resize()); render(); });
});
</script>
</body>
</html>
