<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·∫êEN ‚Äî Activit√© du r√©seau en direct</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
/* ===================== DESIGN SYSTEM TOKENS ===================== */
:root {
  --radius: 6px;
  --moss:       #3d6147;
  --moss-light: #5a8a67;
  --rust:       #c4521a;
  --gold:       #d4a017;
  --green:      #10b981;
  --amber:      #f59e0b;
  --red:        #ef4444;
  --cyan:       #22d3ee;
  --violet:     #8b5cf6;
  --blue:       #3b82f6;
}

[data-theme="dark"] {
  --bg:          #121008;
  --bg2:         #1a1710;
  --surface:     #1e1b12;
  --surface2:    #252118;
  --ink:         #f0ead8;
  --ink-soft:    #c4b896;
  --ink-muted:   #7a7060;
  --border:      rgba(200,180,120,0.12);
  --nav-bg:      rgba(18,16,8,0.92);
  --card-bg:     #1e1b12;
  --card-border: rgba(200,180,120,0.12);
  --kind-default:#7a7060;
  --tag-bg:      #1a2535;
  --tag-text:    #81d4fa;
  --content-bg:  #0e0c07;
}

[data-theme="light"] {
  --bg:          #f5f0e8;
  --bg2:         #ede5d0;
  --surface:     #ede5d0;
  --surface2:    #e5dcc8;
  --ink:         #1c1a14;
  --ink-soft:    #4a4535;
  --ink-muted:   #7a6d55;
  --border:      rgba(122,92,58,0.15);
  --nav-bg:      rgba(245,240,232,0.92);
  --card-bg:     #ede5d0;
  --card-border: rgba(122,92,58,0.15);
  --kind-default:#7a6d55;
  --tag-bg:      #dde8f0;
  --tag-text:    #1a5a8a;
  --content-bg:  #f5f0e8;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--ink);
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: background 0.3s, color 0.3s;
}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav {
  background: var(--nav-bg);
  backdrop-filter: blur(12px);
  padding: 12px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
  gap: 12px;
  flex-wrap: wrap;
  transition: background 0.3s;
}

.nav-left { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }

.nav-logo {
  font-family: 'Playfair Display', serif;
  font-size: 20px; font-weight: 900;
  color: var(--moss); text-decoration: none;
  letter-spacing: -0.01em;
}
.nav-logo span { color: var(--rust); }

.nav-links {
  display: flex; gap: 16px; list-style: none; align-items: center;
}
.nav-links a {
  font-size: 12px; font-weight: 500; color: var(--ink-soft);
  text-decoration: none; letter-spacing: 0.04em; transition: color 0.2s;
}
.nav-links a:hover { color: var(--moss); }
.nav-links a.active { color: var(--moss); font-weight: 600; }

.page-title {
  font-family: 'DM Mono', monospace;
  font-size: 11px; letter-spacing: 0.15em;
  text-transform: uppercase; color: var(--ink-muted);
}

#relay-input {
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--ink);
  padding: 7px 10px;
  border-radius: var(--radius);
  width: 220px;
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  transition: border-color 0.2s;
}
#relay-input:focus { outline: none; border-color: var(--moss); }

.btn {
  cursor: pointer; border: none; padding: 7px 14px;
  border-radius: var(--radius); font-weight: 600; font-size: 12px;
  font-family: 'DM Sans', sans-serif; transition: opacity 0.2s;
}
.btn:hover { opacity: 0.85; }
.btn-moss { background: var(--moss); color: #fff; }
.btn-dim  { background: var(--surface2); color: var(--ink); border: 1px solid var(--border); }

.nav-right { display: flex; align-items: center; gap: 10px; }

.status { display: flex; align-items: center; gap: 8px; }
.status-text { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--ink-muted); }
.dot { width: 10px; height: 10px; border-radius: 50%; background: var(--ink-muted); transition: all 0.3s; }
.dot.connected { background: var(--green); box-shadow: 0 0 8px var(--green); }
.dot.error { background: var(--red); }

.theme-toggle {
  background: var(--surface2); border: 1px solid var(--border);
  color: var(--ink); width: 32px; height: 32px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 15px;
}
.theme-toggle:hover { background: var(--bg2); }

/* ‚îÄ‚îÄ CONTROLS BAR ‚îÄ‚îÄ */
.controls {
  padding: 8px 24px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 20px;
  align-items: center;
  font-size: 11px;
  color: var(--ink-soft);
  flex-wrap: wrap;
  flex-shrink: 0;
}
.controls label { display: flex; align-items: center; gap: 5px; cursor: pointer; }
#filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
#filters label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

/* ‚îÄ‚îÄ FEED ‚îÄ‚îÄ */
main {
  flex: 1;
  overflow-y: auto;
  padding: 16px 24px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.event-card {
  background: var(--card-bg);
  border-radius: 8px;
  border-left: 4px solid var(--kind-default);
  padding: 12px 14px;
  animation: slideIn 0.25s ease-out;
}
@keyframes slideIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

.event-card.kind-30303 { border-left-color: var(--gold); }
.event-card.kind-30304 { border-left-color: var(--violet); }
.event-card.kind-30502 { border-left-color: var(--blue); }
.event-card.kind-30500 { border-left-color: var(--cyan); }
.event-card.kind-30501 { border-left-color: var(--green); }
.event-card.kind-30503 { border-left-color: var(--moss-light); }
.event-card.kind-1 { border-left-color: var(--amber); }
.event-card.kind-0 { border-left-color: var(--rust); }

.event-header {
  display: flex; justify-content: space-between;
  margin-bottom: 8px; font-size: 0.82em; align-items: center; gap: 8px;
}
.kind-badge {
  background: var(--surface2);
  padding: 2px 8px; border-radius: 4px;
  font-family: 'DM Mono', monospace;
  font-size: 10px; font-weight: 600; color: var(--gold);
}
.event-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--ink-muted); }
.pubkey { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--ink-muted); margin-bottom: 6px; }

.content-box {
  background: var(--content-bg);
  padding: 8px 10px; border-radius: 5px; margin: 6px 0;
  white-space: pre-wrap; word-break: break-all;
  font-family: 'DM Mono', monospace; font-size: 11px;
  color: var(--ink-soft); border: 1px solid var(--border);
}
.tag-list { display: flex; flex-wrap: wrap; gap: 4px; margin: 6px 0; }
.tag { font-size: 10px; background: var(--tag-bg); padding: 2px 6px; border-radius: 3px; color: var(--tag-text); font-family: 'DM Mono', monospace; }
.event-id { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--ink-muted); text-align: right; margin-top: 4px; }

.initial-msg { text-align: center; color: var(--ink-muted); margin-top: 60px; font-family: 'DM Mono', monospace; font-size: 12px; }

/* ‚îÄ‚îÄ PROFILES ‚îÄ‚îÄ */
.profile-container {
  margin-bottom: 8px;
}
.profile-link {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: inherit;
  padding: 4px 8px 4px 4px;
  border-radius: 20px;
  background: var(--surface2);
  border: 1px solid var(--border);
  transition: background 0.2s, border-color 0.2s;
}
.profile-link:hover {
  background: var(--nav-bg);
  border-color: var(--moss);
}
.profile-link:hover .profile-name {
  color: var(--moss);
}
.avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  background: #000;
}
.avatar-placeholder {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--bg);
  color: var(--moss);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 14px;
  font-family: 'DM Sans', sans-serif;
}
.profile-name {
  font-weight: 600;
  color: var(--ink);
  font-size: 13px;
  transition: color 0.2s;
}
.profile-pubkey {
  font-family: 'DM Mono', monospace;
  font-size: 10px;
  color: var(--ink-muted);
}

</style>
</head>
<body>

<nav>
  <div class="nav-left">
    <a href="/" class="nav-logo">·∫êEN<span>¬∑</span></a>
    <ul class="nav-links">
      <li><a href="/">Accueil</a></li>
      <li><a href="/boucles">Sch√©ma & TRM</a></li>
      <li><a href="/monitor" class="active">Monitor Nostr</a></li>
      <li><a href="/#feedback">Feedback</a></li>
      <li><a href="/#financer">Soutenir</a></li>
    </ul>
    <span class="page-title">// Activit√© en temps r√©el sur le r√©seau</span>
  </div>
  
  <div class="nav-right">
    <!-- √âL√âMENTS CRITIQUES POUR LE JS -->
    <input type="text" id="relay-input" value="wss://relay.copylaradio.com" title="Adresse du serveur de synchronisation">
    <button class="btn btn-moss" onclick="reconnect()">Connecter</button>
    <div class="status">
      <span class="status-text" id="status-text">D√©connect√©</span>
      <div class="dot" id="status-dot"></div>
    </div>
    <!-- /FIN DES √âL√âMENTS CRITIQUES -->
    
    <button class="theme-toggle" onclick="toggleTheme()" id="themeBtn" aria-label="Basculer le th√®me">üåô</button>
  </div>
</nav>

<div class="controls">
  <label><input type="checkbox" id="scroll-lock" checked> Auto-scroll</label>
  <div id="filters">
    Filtres :
    <label><input type="checkbox" value="30303" checked> Bons ·∫êEN</label>
    <label><input type="checkbox" value="30304" checked> Boucles r√©v√©l√©es</label>
    <label><input type="checkbox" value="30500,30501,30502,30503" checked> Comp√©tences & attestations</label>
    <label><input type="checkbox" value="0,1,3,5,7" checked> Profils & messages</label>
  </div>
  <button class="btn btn-dim" onclick="clearLogs()">Effacer</button>
</div>

<main id="event-feed">
  <div id="initial-message" class="initial-msg">üåª Connexion au serveur en cours... Les √©v√©nements appara√Ætront ici.</div>
</main>

<script>
  /* ‚îÄ‚îÄ THEME ‚îÄ‚îÄ */
function getTheme() { try { return localStorage.getItem('zen-theme') || 'dark'; } catch(e) { return 'dark'; } }
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  document.getElementById('themeBtn').textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  try { localStorage.setItem('zen-theme', t); } catch(e) {}
}
function toggleTheme() { setTheme(document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
setTheme(getTheme());

/* ‚îÄ‚îÄ MONITOR & PROFILES CACHE ‚îÄ‚îÄ */
let socket;
const feed = document.getElementById('event-feed');
const initialMessage = document.getElementById('initial-message');
const relayInput = document.getElementById('relay-input');
const statusText = document.getElementById('status-text');
const statusDot = document.getElementById('status-dot');
const scrollLock = document.getElementById('scroll-lock');

// Cache pour les profils (Kind 0)
const profilesCache = {};
const requestedProfiles = new Set();

function connect() {
  const url = relayInput.value;
  statusText.innerText = "Connexion...";
  statusDot.className = "dot";
  socket = new WebSocket(url);
  
  socket.onopen = () => {
    statusText.innerText = "Connect√©";
    statusDot.className = "dot connected";
    if (initialMessage) initialMessage.style.display = 'none';
    subscribe();
  };
  
  socket.onclose = () => { statusText.innerText = "D√©connect√©"; statusDot.className = "dot"; };
  socket.onerror = () => { statusText.innerText = "Erreur"; statusDot.className = "dot error"; };
  
  socket.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    
    if (data[0] === "EVENT") {
      const event = data[2];
      
      // Si c'est un profil (Kind 0), on le met en cache et on met √† jour l'UI
      if (event.kind === 0) {
        processProfileEvent(event);
      }
      
      renderEvent(event);
    } 
    // Fermer proprement les souscriptions sp√©cifiques aux profils une fois re√ßus
    else if (data[0] === "EOSE" && data[1].startsWith("profile-")) {
      socket.send(JSON.stringify(["CLOSE", data[1]]));
    }
  };
}

function subscribe() {
  // Abonnement principal
  socket.send(JSON.stringify(["REQ", "monitor-tz", { kinds:[0,1,3,5,7,30303,30304,30500,30501,30502,30503], limit:50 }]));
}

/* ‚îÄ‚îÄ GESTION DES PROFILS ‚îÄ‚îÄ */

function processProfileEvent(event) {
  try {
    const profileData = JSON.parse(event.content);
    profilesCache[event.pubkey] = {
      name: profileData.name || profileData.display_name || null,
      picture: profileData.picture || null
    };
    // Mettre √† jour r√©troactivement toutes les cartes affichant cette pubkey
    updateProfileDisplays(event.pubkey);
  } catch (e) {
    console.error("Erreur parsing profil", e);
  }
}

function requestProfileMissing(pubkey) {
  if (requestedProfiles.has(pubkey)) return;
  requestedProfiles.add(pubkey);
  
  // Demander sp√©cifiquement le profil de cet auteur
  const subId = "profile-" + pubkey.substring(0, 8);
  socket.send(JSON.stringify(["REQ", subId, { kinds: [0], authors: [pubkey], limit: 1 }]));
}

function generateProfileHTML(pubkey) {
  const profile = profilesCache[pubkey];
  const shortPubkey = pubkey.substring(0, 8) + '‚Ä¶' + pubkey.substring(58);
  const viewerLink = `https://ipfs.copylaradio.com/ipns/copylaradio.com/nostr_profile_viewer.html?hex=${pubkey}`;

  if (profile) {
    const name = profile.name || 'Anonyme';
    const initial = name.charAt(0).toUpperCase();
    const avatarHtml = profile.picture 
      ? `<img src="${profile.picture}" class="avatar" alt="Avatar" onerror="this.outerHTML='<div class=\\'avatar-placeholder\\'>${initial}</div>'">` 
      : `<div class="avatar-placeholder">${initial}</div>`;
      
    return `
      <a href="${viewerLink}" target="_blank" class="profile-link" title="${pubkey}">
        ${avatarHtml}
        <span class="profile-name">${name}</span>
        <span class="profile-pubkey">${shortPubkey}</span>
      </a>
    `;
  } else {
    // Profil inconnu : on demande au relai et on affiche un placeholder
    requestProfileMissing(pubkey);
    return `
      <a href="${viewerLink}" target="_blank" class="profile-link" title="${pubkey}">
        <div class="avatar-placeholder">?</div>
        <span class="profile-name" style="color: var(--ink-muted)">Recherche...</span>
        <span class="profile-pubkey">${shortPubkey}</span>
      </a>
    `;
  }
}

function updateProfileDisplays(pubkey) {
  const elements = document.querySelectorAll(`.author-${pubkey}`);
  const newHTML = generateProfileHTML(pubkey);
  elements.forEach(el => el.innerHTML = newHTML);
}

/* ‚îÄ‚îÄ RENDU DES √âV√âNEMENTS ‚îÄ‚îÄ */

function renderEvent(event) {
  const card = document.createElement('div');
  card.className = `event-card kind-${event.kind}`;
  
  const activeKinds = getActiveKinds();
  if (!activeKinds.includes(event.kind)) card.style.display = 'none';
  
  const date = new Date(event.created_at * 1000).toLocaleTimeString();
  const labels = { 30303:'üì¶ BON ZEN', 30304:'üéâ BON UTILIS√â (boucle)', 30500:'üìú COMP√âTENCE D√âCLAR√âE', 30501:'üôã DEMANDE D\'ATTESTATION', 30502:'üõ°Ô∏è ATTESTATION PAR UN PAIR', 30503:'‚úÖ COMP√âTENCE VALID√âE', 1:'üí¨ MESSAGE', 0:'üë§ PROFIL' };
  const typeLabel = labels[event.kind] || 'Event';
  const tagsHtml = event.tags.map(t => `<span class="tag">${t[0]}: ${(t[1]||'').substring(0,32)}</span>`).join('');
  
  card.innerHTML = `
    <div class="event-header">
      <span class="kind-badge">${typeLabel} ¬∑ Kind ${event.kind}</span>
      <span class="event-time">${date}</span>
    </div>
    
    <!-- Zone Auteur dynamique -->
    <div class="profile-container author-${event.pubkey}">
      ${generateProfileHTML(event.pubkey)}
    </div>
    
    <div class="tag-list">${tagsHtml}</div>
    <div class="content-box">${formatContent(event.content)}</div>
    <div class="event-id">ID: ${event.id}</div>
  `;
  
  feed.appendChild(card);
  if (scrollLock.checked) feed.scrollTop = feed.scrollHeight;
}

function formatContent(content) {
  try { return JSON.stringify(JSON.parse(content), null, 2); } catch(e) { return content; }
}

function getActiveKinds() {
  const kinds = [];
  document.querySelectorAll('#filters input[type=checkbox]:checked').forEach(cb => {
    cb.value.split(',').forEach(k => kinds.push(parseInt(k)));
  });
  return kinds;
}

function reconnect() { if (socket) socket.close(); connect(); }
function clearLogs() {
  feed.innerHTML = '';
  feed.appendChild(initialMessage);
  initialMessage.style.display = 'block';
}

// D√©marrage
connect();
</script>

</body>
</html>
