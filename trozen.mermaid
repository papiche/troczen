sequenceDiagram
    autonumber

    box rgba(0, 150, 255, 0.1) Application A (Alice - √âmetteur)
    actor Alice
    participant CacheA as Cache Local A<br/>(SecureStorage/SQLite)
    end

    participant Nostr as Relais Nostr<br/>(R√©seau)

    box rgba(0, 200, 100, 0.1) Application B (Bob - Receveur)
    participant CacheB as Cache Local B<br/>(SecureStorage/SQLite)
    actor Bob
    end

    %% =======================================================
    %% PHASE 1 : EMBARQUEMENT
    %% =======================================================
    note over Alice, Nostr: PHASE 1 : EMBARQUEMENT (ONBOARDING)

    Alice->>CacheA: G√©n√©ration et stockage Cl√©s Utilisateur (npub_A, nsec_A)
    Alice->>CacheA: Stockage Graine du March√© (seed_market)
    Alice->>Nostr: Publication Profil Utilisateur<br/>(Nom, avatar IPFS, tags...)

    Alice->>Nostr: REQ (Filtre: Kind 30303, March√© X)
    Nostr-->>Alice: Liste des P3 chiffr√©s existants
    Alice->>Alice: D√©rivation K_day = HMAC(seed_market, date)
    Alice->>CacheA: D√©chiffre et stocke les P3 dans SQLite (Cache P3)

    %% =======================================================
    %% PHASE 2 : CR√âATION DU PREMIER BON
    %% =======================================================
    note over Alice, Nostr: PHASE 2 : CR√âATION D'UN BON (√âMISSION)

    Alice->>Alice: G√©n√©ration Cl√©s du Bon (npub_B, nsec_B)
    Note over Alice: D√©coupage SSSS(nsec_B) ‚ûî P1 (Ancre), P2 (Voyageur), P3 (T√©moin)

    Alice->>CacheA: Sauvegarde Bon (P1, P2, m√©tadonn√©es) dans le Wallet
    Alice->>CacheA: Sauvegarde P3 dans le Cache P3 local

    Alice->>Alice: Chiffre P3 avec K_day
    Alice->>Alice: Reconstruit nsec_B en RAM (P2 + P3)
    Alice->>Nostr: Publie Cr√©ation Bon<br/>(Tags: P3_chiffr√©, Valeur, Raret√©) - Sign√© par nsec_B
    Note over Alice: üßπ nsec_B est effac√© de la RAM (zeroise)

    %% =======================================================
    %% PHASE 3 : SYNCHRONISATION DU RECEVEUR
    %% =======================================================
    note over Nostr, Bob: PHASE 3 : SYNCHRONISATION (BOB)

    Bob->>Nostr: REQ Sync du matin (Kind 30303)
    Nostr-->>Bob: Re√ßoit le Bon d'Alice
    Bob->>Bob: D√©rive K_day et d√©chiffre P3
    Bob->>CacheB: Stocke P3 du Bon (Essentiel pour valider offline)

    %% =======================================================
    %% PHASE 4 : TRANSFERT ATOMIQUE OFFLINE
    %% =======================================================
    note over Alice, Bob: PHASE 4 : TRANSFERT ATOMIQUE (100% OFFLINE)

    Note over Alice, Bob: √âtape A : L'Offre (QR 1)
    Alice->>CacheA: R√©cup√®re P3 du Bon
    Alice->>Alice: Chiffre P2 (Cl√© AES = SHA256(P3))<br/>G√©n√®re Challenge al√©atoire
    Alice->>Bob: üì± Affiche QR1

    Note over Alice, Bob: √âtape B : R√©ception & V√©rification
    Bob->>CacheB: R√©cup√®re P3 local via npub_B
    Bob->>Bob: D√©chiffre P2_chiffr√© gr√¢ce √† P3
    Bob->>Bob: Reconstruit nsec_B = P2 + P3 (en RAM)
    Bob->>Bob: Signe le Challenge d'Alice avec nsec_B

    Note over Bob: En arri√®re-plan (D√®s que le r√©seau revient)
    Bob->>Nostr: Publie Transfert<br/>(Sign√© par le Bon) pour le Dashboard Marchand
    Note over Bob: üßπ nsec_B est effac√© de la RAM (zeroise)
    Bob->>CacheB: Sauvegarde le Bon (avec P2) dans son Wallet

    Note over Alice, Bob: √âtape C : Accus√© de R√©ception (QR 2)
    Bob->>Alice: üì± Affiche QR2 (ACK)

    Note over Alice, Bob: √âtape D : Finalisation
    Alice->>Alice: V√©rifie la Signature(Challenge) avec npub_B (Cl√© publique du bon)
    Alice->>CacheA: üóëÔ∏è Supprime/Invalide P2 du Wallet (Bon = d√©pens√©)

    Note over Alice, Bob: ‚úÖ TRANSFERT TERMIN√â ET S√âCURIS√â